id: main
namespace: chi-traffic

tasks:
  - id: workingDirectory
    type: io.kestra.plugin.core.flow.WorkingDirectory
    tasks:
    - id: cloneRepository
      type: io.kestra.plugin.git.Clone
      url: https://github.com/alepanti/ChiTrafficInsights
      branch: main

    - id: pythonScript
      type: io.kestra.plugin.scripts.python.Commands
      env:
        DESTINATION__FILESYSTEM__BUCKET_URL: "{{ kv('GCS_URL')}}"
        DESTINATION__CREDENTIALS__PROJECT_ID: "{{ kv('GCP_PROJECT_ID') }}"
        DESTINATION__CREDENTIALS__PRIVATE_KEY: "-----BEGIN PRIVATE KEY-----\nMIIEvwIBADANBgkqhkiG9w0BAQEFAASCBKkwggSlAgEAAoIBAQDdzWgkHa2XGIfU\nNkkgttB2LWIpBCRX/6dRsHuShQIZurGcgTEnl5dksjNaDLaNrP4gbVNOD9b8tkXz\nlgzN6Nsf3KZU4cQqqVUaOnbN66s1PgEEOoUz7gsP4Fszv6OdUOU4Lq9Iv6xpmjit\na4Yt2LkGrS7KgcfOMJpfWUJFfnPxvFcMCD1ISsyahPCCQyBsHbUOSHg6tM0e4IQs\nhJEtmxiNLcJTj8jfEvthdk47X5f61+8XNYrLjdZCvX+YRSxZB5pbT9LIdFqRtKby\n8hSWP9HXGmHW/LCdanUzXSIx7r2dayBGEhmsF+hY2vYmxA5hMbte7OxltcTVuXUm\nxrzhBb3NAgMBAAECggEAFRb8YX6+7ECFXczBnE41uR7sl/jQWduxtadBwLdL8VVa\noQZ5vYmA+C6nilbuHr+FtGCgzKnd586PDS/FzOhouXlaCXUkGWhbcrB/bmoLr/bS\n0uubkcn/HEXZdiyxKnqwKOzrds/e3XWwEPFJ418ZjMR30AKSFI1ziEBs+D2jWadB\nCXDBtRj0G7Sv+YP1onMfrBxVTj0ktPB56NId1llRQiuud/hBhWLrEjd95uo5hpVP\nSKSA88amwzWHIsKVoqxwQYc+NPPQ+gywLGAmlu7F54B6t703ExlCpQwRclx+SZuh\nrWaem5ALPS0pJI98pPXKmtW0AqyopKJIxRD3dxFycwKBgQD2+u7IQ97UAhWP7Y7J\nc6L4uszWGqFY5+lwl1ESsYlPsiXxKPjwL9fbS1wAunnDRFFibwxn11i0ZHYg0e9J\nSMH/TYAToVcLUnMesisBFfBWHHtgGeuuAu3FrODNMpPXUL1wHuS11/2N7kAT3l/W\nnid9T2Y/RPaIBfVlZ0zDhlGHowKBgQDl5xTZkgtBrE5xZTzD/AB4x0ArzqzF0eWa\nPHF6zyvTb0FjH4IuySKpuYXUNsLFK+cI+MWCf41VOdu45V0Uni9srJeJkwjvnVi7\n85zyy/0KC366aXKWLR0ztpqhRLQKYrOXlbx6ERUVFQlBzxe8aqKSAXapKyd9VrjP\nIfr9UTe7zwKBgQCgrh5dQfKdQYHfsnC71TSI15beEFM6MR7pdjhzjfdEVyViIQLb\n2HR5oiyH+Mmw5SiBfre2cx6ttdI4hfxEVEaKH1Sc8NFdd1WX+dgKi8hhbYRCwHpZ\nKmSgv1k9hpMyeL/WSvMG7y9xgDhF9N2rFheg6eAed3JgimfdgfgqGJ/AOwKBgQCs\nrxfAHKyL1arODebIpt6L2c3fmcu4guJdKY1rW3VlySlqFN6p2bZJmepl7gP6KfHN\nkV55mOlF3MGnbdCujeq9TB4+3cxWfu+JrYBz9rjH9L5pso65MoW+tCgNfhdlvaF7\n+KKrZW1aeoSLg8wmYEpgNO02QA3XXW5PVwy5fWnJjQKBgQCm6M9czD0K8w42ItJO\nLugOeh5b7Qp8Yi19Xp1lj5LG2By7abTbKJ8Qd+MMaqJiWK5Y8n384OMEpn6cCrPs\n+EOegfox6HHhXbTqHyee1aehl+M08t8JxHYHZFk27OGKMYXDf5hR0MjoP+Cv+bAj\n7HbKq74nAyYhfkKgzLgxT4KNiQ==\n-----END PRIVATE KEY-----"
        DESTINATION__CREDENTIALS__CLIENT_EMAIL: "{{ kv('GCP_CLIENT_EMAIL') }}"
      warningOnStdErr: false
      containerImage: python:3.11
      beforeCommands:
        - pip install -r dlt/requirements.txt
        - dlt --non-interactive init chitraffic_api filesystem
        - rm .dlt/secrets.toml
      commands:
        - python dlt/chit_pipeline.py