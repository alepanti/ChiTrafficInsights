id: main
namespace: chi-traffic

tasks:
  - id: workingDirectory
    type: io.kestra.plugin.core.flow.WorkingDirectory
    tasks:
    - id: cloneRepository
      type: io.kestra.plugin.git.Clone
      url: https://github.com/alepanti/ChiTrafficInsights
      branch: main

    - id: pythonScript
      type: io.kestra.plugin.scripts.python.Commands
      env:
        CREDENTIALS__PROJECT_ID: "{{ secret('BIGQUERY_PROJECT_ID') }}"
        CREDENTIALS__PRIVATE_KEY: "{{ secret('BIGQUERY_PRIVATE_KEY') }}"
        CREDENTIALS__CLIENT_EMAIL: "{{ secret('BIGQUERY_CLIENT_EMAIL') }}"
      warningOnStdErr: false
      containerImage: python:3.11
      beforeCommands:
        - pip install -r dlt/requirements.txt
        - dlt --non-interactive init chitraffic_api filesystem
        - sed -i 's|bucket_url = .*|bucket_url = "{{kv('GCS_URL')}}"|' secrets.toml
      commands:
        - python dlt/chit_pipeline.py