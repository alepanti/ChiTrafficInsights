id: main
namespace: chi-traffic

inputs:
  - id: date
    type: DATETIME
    defaults: "2025-03-25T20:19:00Z"
    displayName: "Backfill date for load"

tasks:
  - id: workingDirectory
    type: io.kestra.plugin.core.flow.WorkingDirectory
    tasks:
    - id: cloneRepository
      type: io.kestra.plugin.git.Clone
      url: https://github.com/alepanti/ChiTrafficInsights
      branch: main

    - id: getAPIdata
      type: io.kestra.plugin.scripts.python.Commands
      taskRunner:
        type: io.kestra.plugin.core.runner.Process
      warningOnStdErr: false
      beforeCommands:
        - pip install -r api_load/requirements.txt
        - export BACKFILL_DATE="{{ inputs.date | date('yyyy-MM-dd\'T\'HH:mm:ss.SSS') }}"
      commands:
        - python api_load/api_load.py
    
    - id: loadBQ
      type: io.kestra.plugin.scripts.python.Commands
      taskRunner:
        type: io.kestra.plugin.core.runner.Process
      env:
        SOURCES__FILESYSTEM__BUCKET_URL: "{{ kv('GCS_URL')}}"
        SOURCES__FILESYSTEM__FILE_GLOB: "*.csv"
      warningOnStdErr: false
      beforeCommands:
        - pip install -r dlt_bq/requirements.txt
        - export GOOGLE_APPLICATION_CREDENTIALS='/.gcp/credentials.json'
        - dlt --non-interactive init filesystem bigquery
        - rm .dlt/secrets.toml
      commands:
        - python dlt_bq/load_bq.py